<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <meta name="generator" content="Madoko, version 0.6.3-beta" />
  <meta name="viewport" content="initial-scale=1.0" />
  <meta name="author" content="Paige Rinnert" />
  <link rel="stylesheet" type="text/css" href="madoko.css">
  <link rel="stylesheet" type="text/css" href="./writeup.css">
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {inlineMath: [['$','$']]},
       TeX: { 
         Macros: { mathid: ['\\mathit{#1\\hspace{0.1ex}}',1], mathkw: ['\\mathsf{#1}',1],
                   mathspace: ['\\hspace{#1pt}\\hspace{#1pt}\\hspace{#1pt}',1], mathindent: ['\\hspace{#1ex}',1], mathbr: ['\\\\'],
                 },
  
       }
    });
    MathJax.Hub.Register.StartupHook('TeX AMSmath Ready',function () { 
      MathJax.InputJax.TeX.Definitions.environment['mdMathprearray'] = ['AMSarray',null,null,null,'l','0em','0em'];
    });
  </script>
  <script type="text/javascript"
    src="https://c328740.ssl.cf1.rackcdn.com/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>

</head>
<body class="madoko">

<h1 id="logging-and-backups"  data-line="8;logs_backups.md:1" ><span data-line="8;logs_backups.md::1"></span>Logging and Backups</h1>
<p data-line="8;logs_backups.md:2"><span data-line="8;logs_backups.md::2"></span><em>Originally created by Paige Rinnert</em><span data-line="8;logs_backups.md::2"></span>
</p>
<p class="indent" data-line="8;logs_backups.md:4"><span data-line="8;logs_backups.md::4"></span>In this lab, we<span data-line="8;logs_backups.md::4"></span>&#39;<span data-line="8;logs_backups.md::4"></span>ll explore ways of storing and investigating the past behavior
of our systems.
</p><h2 id="logging"  data-line="8;logs_backups.md:7" ><span data-line="8;logs_backups.md::7"></span>Logging</h2>
<p data-line="8;logs_backups.md:9"><span data-line="8;logs_backups.md::9"></span>Many logging servers use syslog, and since almost all machines use it,
it is easy to to sync the logging of multiple devices. Once a syslog
server is set up, devices can send their log messages over the network
to the server rather than recording them in a local file or displaying
them. Doing this creates a central logging server that becomes a
repository for log messages.
</p>
<p class="indent" data-line="8;logs_backups.md:16"><span data-line="8;logs_backups.md::16"></span>A severity level can be used to decide which messages are sent. The
levels are standardized and identified by a number and/or a standard
abbreviation:
</p><table class="madoko block" data-line="8;logs_backups.md:20">
<thead><tr><th class="cell-line"></th><th class="cell-line"></th><th class="cell-line"></th></tr>
<tr><th> Number    </th><th> Description      </th><th> Abbr.     </th></tr></thead>
<tbody><tr><td class="cell-line"></td><td class="cell-line"></td><td class="cell-line"></td></tr>
<tr><td> 0         </td><td> Emergency        </td><td> emerg     </td></tr>
<tr><td> 1         </td><td> Alerts           </td><td> alert     </td></tr>
<tr><td> 2         </td><td> Critical         </td><td> crit      </td></tr>
<tr><td> 3         </td><td> Errors           </td><td> err       </td></tr>
<tr><td> 4         </td><td> Warnings         </td><td> warn      </td></tr>
<tr><td> 5         </td><td> Notification     </td><td> notice    </td></tr>
<tr><td> 6         </td><td> Information      </td><td> info      </td></tr>
<tr><td> 7         </td><td> Debug            </td><td> debug     </td></tr>
<tr><td class="cell-line"></td><td class="cell-line"></td><td class="cell-line"></td></tr></tbody></table>
<p data-line="8;logs_backups.md:33"><span data-line="8;logs_backups.md::33"></span>There are also things called <span data-line="8;logs_backups.md::33"></span>&#8220;facilities&#8221;<span data-line="8;logs_backups.md::33"></span> which loosely relate to
system processes, a way of categorizing messages. When a remote device
sends a message to a syslog server it includes one of the standard
facility values (along with a severity level). Some of the common
facilities are:
</p><table class="madoko block" data-line="8;logs_backups.md:39">
<thead><tr><th class="cell-line"></th><th class="cell-line"></th></tr>
<tr><th> Code                </th><th> Explanation                                     </th></tr></thead>
<tbody><tr><td class="cell-line"></td><td class="cell-line"></td></tr>
<tr><td> auth                </td><td> authentication (login) messages                 </td></tr>
<tr><td> cron                </td><td> messages from the memory-resident scheduler     </td></tr>
<tr><td> daemon              </td><td> messages from resident daemons                  </td></tr>
<tr><td> kern                </td><td> kernel messages                                 </td></tr>
<tr><td> lpr                 </td><td> printer messages (used by JetDirect cards)      </td></tr>
<tr><td> mail                </td><td> messages from Sendmail                          </td></tr>
<tr><td> user                </td><td> messages from user-initiated processes/apps     </td></tr>
<tr><td> local0 - local7     </td><td> user-defined                                    </td></tr>
<tr><td> syslog              </td><td> messages from the syslog process itself         </td></tr>
<tr><td class="cell-line"></td><td class="cell-line"></td></tr></tbody></table>
<p data-line="8;logs_backups.md:53"><span data-line="8;logs_backups.md::53"></span>One can specify different severity levels for different facilities so
one can, for example, log all kernel messages but only emergency
messages from printers. The logs can then be viewed on the central
server. How a server is set up differs with the main operating system
being used.
</p><h3 id="using-sysklogd"  data-line="8;logs_backups.md:59" ><span data-line="8;logs_backups.md::59"></span>Using sysklogd</h3>
<p data-line="8;logs_backups.md:61"><span data-line="8;logs_backups.md::61"></span>Your system will be running <span data-line="8;logs_backups.md::61"></span><code class="code">sysklogd</code><span data-line="8;logs_backups.md::61"></span>. The file used to configure syslog
is <span data-line="8;logs_backups.md::62"></span><code class="code">/etc/syslog.conf</code><span data-line="8;logs_backups.md::62"></span>. In addition to sysklogd, your system is running
<span data-line="8;logs_backups.md::63"></span><code class="code">logrotate</code><span data-line="8;logs_backups.md::63"></span>. This program determines how long a system saves old logs and how
old and new logs are managed.
</p>
<p class="indent" data-line="8;logs_backups.md:66"><span data-line="8;logs_backups.md::66"></span>If you’re interested in the different kinds of loggers that you can use
on a Gentoo system, you can read more about them on the Gentoo website:
<span data-line="8;logs_backups.md::68"></span><a href="https://www.gentoo.org/doc/en/security/security-handbook.xml?part=1&amp;chap=3">https://www.gentoo.org/doc/en/security/security-handbook.xml?part=1&amp;chap=3</a><span data-line="8;logs_backups.md::68"></span>.
</p><h3 id="logs-found-in-varlog"  data-line="8;logs_backups.md:70" ><span data-line="8;logs_backups.md::70"></span>Logs found in /var/log</h3>
<p class="para-continue" data-line="8;logs_backups.md:72"><span data-line="8;logs_backups.md::72"></span>Run <span data-line="8;logs_backups.md::72"></span><code class="code">ls</code><span data-line="8;logs_backups.md::72"></span> in the directory <span data-line="8;logs_backups.md::72"></span><code class="code">/var/log</code><span data-line="8;logs_backups.md::72"></span>. These are the 
<span data-line="8;logs_backups.md::73"></span><a href="http://www.thegeekstuff.com/2011/08/linux-var-log-files">logs maintained by the system</a><span data-line="8;logs_backups.md::73"></span>. 
Usually you need
to use sudo to view log files. (Since logs tend to be
thousands of lines long, here is a helpful hint for viewing them: in
vim, typing SHIFT-G will take you to the bottom of a file while typing
gg will return you to the top. Also don’t forget that you can search
files.)
</p>
<ol class="loose" data-line="8;logs_backups.md:81">
<li data-line="8;logs_backups.md:81">
<p data-line="8;logs_backups.md:81"><span data-line="8;logs_backups.md::81"></span><code class="code">auth.log</code><span data-line="8;logs_backups.md::81"></span> contains authorization records, including logins and uses of <span data-line="8;logs_backups.md::81"></span>`<span data-line="8;logs_backups.md::81"></span>
su
</p>
<p data-line="8;logs_backups.md:84"><span data-line="8;logs_backups.md::84"></span>Look at your auth.log file. You should see some lines like this,
among others. The line below is a record of using the sudo command
to view this file, auth.log, from the directory /var/log
(<span data-line="8;logs_backups.md::87"></span><code class="code">PWD=/var/log</code><span data-line="8;logs_backups.md::87"></span>) using the command vim (<span data-line="8;logs_backups.md::87"></span><code class="code">COMMAND=/usr/bin/vim</code><span data-line="8;logs_backups.md::87"></span>).
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:89"><code>Jul  2 10:09:56 penguin sudo: prinnert : TTY=tty1 ; PWD=/var/log ; 
USER=root ; COMMAND=/usr/bin/vim auth.log</code></pre>
<p data-line="8;logs_backups.md:92"><span data-line="8;logs_backups.md::92"></span><strong>Open your auth.log file and see if you can find some of the commands
you have recently performed using sudo.</strong><span data-line="8;logs_backups.md::93"></span>
</p></li>
<li data-line="8;logs_backups.md:95">
<p data-line="8;logs_backups.md:95"><span data-line="8;logs_backups.md::95"></span><code class="code">emerge.log</code><span data-line="8;logs_backups.md::95"></span> contains a record of every package emerged on the
system, whether the emerge finished successfully or not.
</p>
<p data-line="8;logs_backups.md:98"><span data-line="8;logs_backups.md::98"></span>Here is a sample output of a package emerge (this example is
emerging telnet):
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:101"><code>1413356210:  *** emerge  cowsay
1413356231:  &gt;&gt;&gt; emerge (1 of 1) games-misc/cowsay-3.03-r2 to /
1413356232:  === (1 of 1) Cleaning (games-misc/cowsay-3.03-r2::/usr/portage/games-misc/cowsay/cowsay-3.03-r2.ebuild)
1413356232:  === (1 of 1) Compiling/Merging (games-misc/cowsay-3.03-r2::/usr/portage/games-misc/cowsay/cowsay-3.03-r2.ebuild)
1413356236:  === (1 of 1) Merging (games-misc/cowsay-3.03-r2::/usr/portage/games-misc/cowsay/cowsay-3.03-r2.ebuild)
1413356238:  &gt;&gt;&gt; AUTOCLEAN: games-misc/cowsay:0
1413356239:  === (1 of 1) Updating world file (games-misc/cowsay-3.03-r2)
1413356239:  === (1 of 1) Post-Build Cleaning (games-misc/cowsay-3.03-r2::/usr/portage/games-misc/cowsay/cowsay-3.03-r2.ebuild)
1413356239:  ::: completed emerge (1 of 1) games-misc/cowsay-3.03-r2 to /
1413356239:  *** Finished. Cleaning up...
1413356240:  *** exiting successfully.
1413356241:  *** terminating.</code></pre>
<p data-line="8;logs_backups.md:114"><span data-line="8;logs_backups.md::114"></span>However, below is an example of an entry in the emerge log after
attempting to emerge a package that doesn’t exist. This is an
example of trying to emerge telnet without using the correct package
name.
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:119"><code>1403904498: Started emerge on: Jun 27, 2014 14:28:18
1403904498:  *** emerge  telnet
1403904499:  *** exiting unsuccessfully with status &#39;1&#39;.
1403904499:  *** terminating.</code></pre>
<p data-line="8;logs_backups.md:124"><span data-line="8;logs_backups.md::124"></span>Note that the program exited unsuccessfully with status 1. A
successful command will always exit with status 0 and any other exit
status indicates an error. Usually the status 1 is used as a
catch-all for all general errors.
</p>
<p data-line="8;logs_backups.md:129"><span data-line="8;logs_backups.md::129"></span><strong>Scroll through your emerge.log file and look for some of the
packages you’ve installed recently.</strong><span data-line="8;logs_backups.md::130"></span>
</p></li>
<li data-line="8;logs_backups.md:132">
<p data-line="8;logs_backups.md:132"><span data-line="8;logs_backups.md::132"></span><code class="code">mail.log</code><span data-line="8;logs_backups.md::132"></span> contains a record of the emails you have sent and
received.
</p>
<p data-line="8;logs_backups.md:135"><span data-line="8;logs_backups.md::135"></span>Sample output in mail.log when an email was sent from the computer
penguin to the computer heisenberg:
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:138"><code>Jul  2 10:38:48 penguin postfix/pickup[20871]: C8762CA377D: uid=1000 
from=&lt;root&gt;
Jul  2 10:38:48 penguin postfix/cleanup[21281]: C8762CA377D: message-id=
&lt;20140702173848.GA21269@penguin.sys.cs.hmc.edu&gt;
Jul  2 10:38:48 penguin postfix/qmgr[12656]: C8762CA377D: from=&lt;root
@sys.cs.hmc.edu&gt;, size=533, nrcpt=1 (queue active)
Jul  2 10:38:49 penguin postfix/smtp[21283]: C8762CA377D: to=&lt;root@
heisenberg.sys.cs.hmc.edu&gt;, relay=heisenberg.sys.cs.hmc.edu[134.173.43.69]
:25, delay=0.64, delays=0.17/0.06/0.32/0.08, dsn=2.0.0, status=sent 
(250 2.0.0 Ok: queued as 74E63AE0434)
Jul  2 10:38:49 penguin postfix/qmgr[12656]: C8762CA377D: removed</code></pre>
<p data-line="8;logs_backups.md:150"><span data-line="8;logs_backups.md::150"></span><strong>Send an email to a friend’s computer using either sendmail or mutt,
and have them send you an email. Go to your mail log and look at
what appears in the log when you send an email and when you receive
one.</strong><span data-line="8;logs_backups.md::153"></span>
</p></li>
<li data-line="8;logs_backups.md:155">
<p data-line="8;logs_backups.md:155"><span data-line="8;logs_backups.md::155"></span><code class="code">user.log</code><span data-line="8;logs_backups.md::155"></span> contains a record of when your computer has been shut
down or rebooted.
</p></li></ol>
<h3 id="compressed-files"  data-line="8;logs_backups.md:158" ><span data-line="8;logs_backups.md::158"></span>Compressed Files</h3>
<p data-line="8;logs_backups.md:161"><span data-line="8;logs_backups.md::161"></span>Notice that there are a bunch of zipped files in /var/log. These files all end 
in the extension <span data-line="8;logs_backups.md::162"></span><code class="code">.gz</code><span data-line="8;logs_backups.md::162"></span>, showing that they are
zipped (compressed) files.
</p>
<p class="indent" data-line="8;logs_backups.md:165"><span data-line="8;logs_backups.md::165"></span>The system uses compressed files because they take up less disk space.
The programs that zip and unzip files are called <span data-line="8;logs_backups.md::166"></span><code class="code">gzip</code><span data-line="8;logs_backups.md::166"></span> and <span data-line="8;logs_backups.md::166"></span><code class="code">gunzip</code><span data-line="8;logs_backups.md::166"></span>,
respectively. Try unzipping one of the zipped log files by running the
following command. You will probably need to sudo.
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:170"><code>gunzip &lt;filename&gt;</code></pre>
<p data-line="8;logs_backups.md:172"><span data-line="8;logs_backups.md::172"></span>Now run <span data-line="8;logs_backups.md::172"></span><code class="code">ls</code><span data-line="8;logs_backups.md::172"></span> in /var/log. You will see that the file you just unzipped
has lost the extension .gz. There is
really no reason to have it unzipped though, so go ahead and re-zip it
with this command:
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:177"><code>gzip &lt;filename&gt;</code></pre>
<p data-line="8;logs_backups.md:179"><span data-line="8;logs_backups.md::179"></span>Now that our zipped log file is back to how it was when we found it, run
the following:
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:182"><code>ls -l /var/log/auth*</code></pre>
<p data-line="8;logs_backups.md:184"><span data-line="8;logs_backups.md::184"></span>You should see the current auth log file (<span data-line="8;logs_backups.md::184"></span><code class="code">auth.log</code><span data-line="8;logs_backups.md::184"></span>) as well as any
zipped versions of the file. Compare their filesizes. The zipped files
may be up to one-tenth the size of the regular, uncompressed log files.
Usually compression techniques work by eliminating redundant data or
expressing it in a more succinct way.
</p>
<p class="indent" data-line="8;logs_backups.md:190"><span data-line="8;logs_backups.md::190"></span>Each of the red, zipped files in /var/log is an old log that is
compressed to save space. The logger syslogd automatically compresses
them because it makes sense to compress older log files that you most
likely won’t need. However, it is good to keep these files rather than
just deleting them because they may be useful if you have any security
breaches or mysterious errors.
</p><h3 id="remote-logging"  data-line="8;logs_backups.md:197" ><span data-line="8;logs_backups.md::197"></span>Remote Logging</h3>
<p data-line="8;logs_backups.md:199"><span data-line="8;logs_backups.md::199"></span>You may have noticed while perusing your log files that it is very easy
to retroactively make changes to a log file or even delete information.
It would be entirely possible to delete lines in a mail log so that it
looks like a message was never sent, or go into the auth log file and
erase a series of commands performed with sudo. One way to protect your
computer against log file alteration by a hacker in covering their
tracks is by enabling remote logging.
</p>
<p class="indent" data-line="8;logs_backups.md:207"><span data-line="8;logs_backups.md::207"></span>Remote logging allows a computer to log information on another server as
well as in its own log files. This means that if information is deleted
from the log files on the computer, there is still a record of them on
another computer. These files could be compared to determine if any
alterations were made to the log files and what the changes were.
</p>
<p class="indent" data-line="8;logs_backups.md:214"><span data-line="8;logs_backups.md::214"></span><strong>Pick a partner (or form a larger team) for remote logging.</strong><span data-line="8;logs_backups.md::214"></span>
</p>
<p class="indent para-continue" data-line="8;logs_backups.md:216"><span data-line="8;logs_backups.md::216"></span>Complete the following steps to enable somone else to store their logs on your
machine:
</p>
<ol class="loose" data-line="8;logs_backups.md:219">
<li data-line="8;logs_backups.md:219">
<p data-line="8;logs_backups.md:219"><span data-line="8;logs_backups.md::219"></span>The syslogd program needs the<span data-line="8;logs_backups.md::219"></span> <span data-line="8;logs_backups.md::219"></span>-r flag enabled, to tell it to listen for log
events on the network. You can set this flag on the command
line when you start sysklogd (like this: <span data-line="8;logs_backups.md::221"></span><code class="code">syslogd -r</code><span data-line="8;logs_backups.md::221"></span>) but this is
not permanent and requires you to kill syslogd and then start it
again from the command line. A better option is to edit the file
<span data-line="8;logs_backups.md::224"></span><code class="code">/etc/conf.d/sysklogd</code><span data-line="8;logs_backups.md::224"></span> and add the<span data-line="8;logs_backups.md::224"></span> <span data-line="8;logs_backups.md::224"></span>-r flag to the <span data-line="8;logs_backups.md::224"></span><code class="code">SYSLOGD</code><span data-line="8;logs_backups.md::224"></span>
variable. The file should now look like:
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:227"><code> SYSLOGD=&quot;-m 0 -r&quot;
 KLOGD=&quot;-c 3 -2&quot;</code></pre></li>
<li data-line="8;logs_backups.md:230">
<p data-line="8;logs_backups.md:230"><span data-line="8;logs_backups.md::230"></span>Since the default behavior of syslogd is that it does not listen on
the network, we need to make sure that syslog is set up to listen on
the standard port in <span data-line="8;logs_backups.md::232"></span><code class="code">/etc/services</code><span data-line="8;logs_backups.md::232"></span>. Search for the number 514 and
make sure the following line is in the file. If it’s not there, add
it.
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:236"><code>syslog  514/udp</code></pre></li>
<li data-line="8;logs_backups.md:238">
<p data-line="8;logs_backups.md:238"><span data-line="8;logs_backups.md::238"></span>Restart system logging by running the following command:
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:240"><code> 
 sudo /etc/init.d/sysklogd restart</code></pre></li></ol>

<p class="para-continue" data-line="8;logs_backups.md:242"><span data-line="8;logs_backups.md::242"></span>Here are the steps to export your logs to another system:
</p>
<ol class="loose" data-line="8;logs_backups.md:244">
<li data-line="8;logs_backups.md:244">
<p data-line="8;logs_backups.md:244"><span data-line="8;logs_backups.md::244"></span>Get the hostname of your friend<span data-line="8;logs_backups.md::244"></span>&#39;<span data-line="8;logs_backups.md::244"></span>s machine, i.e., the one to which you<span data-line="8;logs_backups.md::244"></span>&#39;<span data-line="8;logs_backups.md::244"></span>ll send 
your logs. The hostname should have the form <span data-line="8;logs_backups.md::245"></span><code class="code">vm#.sys.cs.hmc.edu</code><span data-line="8;logs_backups.md::245"></span>.
</p></li>
<li data-line="8;logs_backups.md:247">
<p data-line="8;logs_backups.md:247"><span data-line="8;logs_backups.md::247"></span>Open the file <span data-line="8;logs_backups.md::247"></span><code class="code">/etc/syslog.conf</code><span data-line="8;logs_backups.md::247"></span>. This file contains lists of the
various logs kept by the system. Add your friend<span data-line="8;logs_backups.md::248"></span>&#39;<span data-line="8;logs_backups.md::248"></span>s hostname of a friend’s
computer near the top of the file with this syntax:
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:251"><code>*.* @hostname.domainname</code></pre>
<p data-line="8;logs_backups.md:253"><span data-line="8;logs_backups.md::253"></span>The <span data-line="8;logs_backups.md::253"></span>*<span data-line="8;logs_backups.md::253"></span>.<span data-line="8;logs_backups.md::253"></span>*<span data-line="8;logs_backups.md::253"></span> causes all messages to be logged on the remote host. (If
you only wanted one type of message to be logged on the remote host,
for example kernel messages, you would replace <span data-line="8;logs_backups.md::255"></span>*<span data-line="8;logs_backups.md::255"></span>.<span data-line="8;logs_backups.md::255"></span>*<span data-line="8;logs_backups.md::255"></span> with kern.<span data-line="8;logs_backups.md::255"></span>*<span data-line="8;logs_backups.md::255"></span>)
</p></li>
<li data-line="8;logs_backups.md:257">
<p data-line="8;logs_backups.md:257"><span data-line="8;logs_backups.md::257"></span>Restart system logging by running the following command:
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:259"><code> 
 sudo /etc/init.d/sysklogd restart</code></pre></li></ol>

<p data-line="8;logs_backups.md:261"><span data-line="8;logs_backups.md::261"></span>Now you and your partner’s computers should contain the same log files!
If you are both using remote logging to send messages to each other’s
computers, the log files on both will contain the same information. If
information is deleted out of one of the log files, it will still be
present in the other log file. You could then use the diff command to
compare log files if a discrepancy arose. This makes your computer safer
because if a hacker was trying to cover their tracks, they would have to
edit not only the log file on your machine, but also determine that the
logs were being saved remotely and delete logs off of the other machine.
Possible, but more unlikely.
</p><h2 id="important"  data-line="8;logs_backups.md:272" ><span data-line="8;logs_backups.md::272"></span>Important!</h2>
<p data-line="8;logs_backups.md:274"><span data-line="8;logs_backups.md::274"></span>Before moving on, run the following command:
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:276"><code>sudo ./MysteriousScript1</code></pre><h2 id="backups"  data-line="8;logs_backups.md:278" ><span data-line="8;logs_backups.md::278"></span>Backups</h2>
<p data-line="8;logs_backups.md:280"><span data-line="8;logs_backups.md::280"></span>Backups are an important part of any system, as you may well know if you
have ever had your computer crash on you. Saving your files in backups
often will save you if anything happens to your system. This is
especially important when we are doing so much messing around with our
system, because it allows us to restore our files if we screw something
up.
</p>
<p class="indent" data-line="8;logs_backups.md:287"><span data-line="8;logs_backups.md::287"></span>The CS department uses the program AMANDA for our backups (AMANDA stands
for the <span data-line="8;logs_backups.md::288"></span><strong>A</strong><span data-line="8;logs_backups.md::288"></span>dvanced <span data-line="8;logs_backups.md::288"></span><strong>M</strong><span data-line="8;logs_backups.md::288"></span>aryland <span data-line="8;logs_backups.md::288"></span><strong>A</strong><span data-line="8;logs_backups.md::288"></span>utomatic <span data-line="8;logs_backups.md::288"></span><strong>N</strong><span data-line="8;logs_backups.md::288"></span>etwork <span data-line="8;logs_backups.md::288"></span><strong>D</strong><span data-line="8;logs_backups.md::288"></span>isk
<span data-line="8;logs_backups.md::289"></span><strong>A</strong><span data-line="8;logs_backups.md::289"></span>rchiver). It was originally developed at the University of
Maryland’s computer science department and is now a widely used backup
system that is completely open source.
</p><h3 id="making-a-backup"  data-line="8;logs_backups.md:293" ><span data-line="8;logs_backups.md::293"></span>Making a backup</h3>
<ol class="loose" data-line="8;logs_backups.md:296">
<li data-line="8;logs_backups.md:296">
<p data-line="8;logs_backups.md:296"><span data-line="8;logs_backups.md::296"></span>The first step now is to create some directories. Create the
directory /amanda, and then change its owner to amanda.
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:299"><code>sudo mkdir -p /amanda
sudo chown amanda /amanda</code></pre>
<p data-line="8;logs_backups.md:302"><span data-line="8;logs_backups.md::302"></span>Now you will need to switch to the amanda user. Before you can do
this, though, you need to change the password for the amanda user.
<span data-line="8;logs_backups.md::304"></span><strong>We will provide a password for everyone to use, in lab. Ask for the
password when you get this point.</strong><span data-line="8;logs_backups.md::305"></span>
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:307"><code>sudo passwd amanda</code></pre>
<p data-line="8;logs_backups.md:309"><span data-line="8;logs_backups.md::309"></span>Now you can <span data-line="8;logs_backups.md::309"></span><code class="code">su amanda</code><span data-line="8;logs_backups.md::309"></span> and create more directories. (Note that the
-p flag will create the parent directories if they don’t already
exist. Also, the curly braces will create multiple directories in
the same parent directory).
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:314"><code>mkdir -p /amanda/vtapes/slot{1,2,3,4}
mkdir -p /amanda/holding
mkdir -p /amanda/state/{curinfo,log,index}
mkdir -p /etc/amanda/MyConfig </code></pre></li>
<li data-line="8;logs_backups.md:319">
<p data-line="8;logs_backups.md:319"><span data-line="8;logs_backups.md::319"></span>Run the following commands to retrieve a configuration file for your backups
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:321"><code>cd /etc/amanda/MyConfig/        
wget http://www.cs.hmc.edu/courses/current/sysadmin/amanda.conf</code></pre></li>
<li data-line="8;logs_backups.md:324">
<p data-line="8;logs_backups.md:324"><span data-line="8;logs_backups.md::324"></span>Open this config file and browse through it. Notice that the files created in
the previous step are mentioned throughout the config file. Each
backup will have its own folder and config file. If you want to, you
can look at the example amanda.conf file that comes with the amanda
install in /etc/amanda/DailySet1.
</p></li>
<li data-line="8;logs_backups.md:330">
<p data-line="8;logs_backups.md:330"><span data-line="8;logs_backups.md::330"></span>In the directory MyConfig, where you just created the config file
amanda.conf, create the file <span data-line="8;logs_backups.md::331"></span><code class="code">disklist</code><span data-line="8;logs_backups.md::331"></span> and put in the line below.
All lines in the disklist have the format
<span data-line="8;logs_backups.md::333"></span><code class="code">&lt;hostname&gt; &lt;diskname&gt; &lt;dumptype&gt;</code><span data-line="8;logs_backups.md::333"></span>. The hostname here is localhost
and the disk to back up is /home. The dumptype used here is the one
that we just created in the config file.
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:337"><code>localhost /home simple-gnutar-local</code></pre></li>
<li data-line="8;logs_backups.md:339">
<p data-line="8;logs_backups.md:339"><span data-line="8;logs_backups.md::339"></span>Now we need to check that the configuration worked correctly. Since
the amanda commands are all located in /usr/sbin, we want to add
this to the <span data-line="8;logs_backups.md::341"></span><code class="code">PATH</code><span data-line="8;logs_backups.md::341"></span> variable for amanda so that we can run the
commands without including the path every time. As the user amanda,
run <span data-line="8;logs_backups.md::343"></span><code class="code">echo $PATH</code><span data-line="8;logs_backups.md::343"></span>. If /usr/sbin is not there, add this line to the
<span data-line="8;logs_backups.md::344"></span><code class="code">.bashrc</code><span data-line="8;logs_backups.md::344"></span> file in amanda’s home directory (you may need to create
the file if it doesn’t exist):
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:347"><code>export PATH=$PATH:/usr/sbin</code></pre>
<p data-line="8;logs_backups.md:349"><span data-line="8;logs_backups.md::349"></span>To reference this file, now run the following command. Subsequent
times, your updated path will be automatically added to the <span data-line="8;logs_backups.md::350"></span><code class="code">PATH</code><span data-line="8;logs_backups.md::350"></span>
variable on restart.
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:353"><code>source ~/.bashrc</code></pre>
<p data-line="8;logs_backups.md:355"><span data-line="8;logs_backups.md::355"></span>Now check the path variable again, and you should see /usr/sbin. Now
you can run:
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:358"><code>amcheck MyConfig</code></pre>
<p data-line="8;logs_backups.md:360"><span data-line="8;logs_backups.md::360"></span>The output should look something like this:
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:362"><code>Amanda Tape Server Host Check
-----------------------------
NOTE: tapelist will be created on the next run.
Holding disk /amanda/holding: 868352 kB disk space available, using 51200 
kB as requested
slot 1: contains an empty volume
Will write label &#39;MyData01&#39; to new volume in slot 1.
NOTE: skipping tape-writable test
NOTE: host info dir /amanda/state/curinfo/localhost does not exist
NOTE: it will be created on the next run.
NOTE: index dir /amanda/state/index/localhost does not exist
NOTE: it will be created on the next run.
Server check took 0.276 seconds

Amanda Backup Client Hosts Check
--------------------------------
Client check: 1 host checked in 7.089 seconds.  0 problems found.

(brought to you by Amanda 3.3.3)</code></pre>
<p data-line="8;logs_backups.md:382"><span data-line="8;logs_backups.md::382"></span>If there are any extra lines in your output that look like they
might be errors, you will need to resolve these before moving on.
</p></li>
<li data-line="8;logs_backups.md:385">
<p data-line="8;logs_backups.md:385"><span data-line="8;logs_backups.md::385"></span>Now you can run your first backup!
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:387"><code>amdump MyConfig</code></pre>
<p data-line="8;logs_backups.md:389"><span data-line="8;logs_backups.md::389"></span>The command should take a few seconds to run, that’s probably a good
thing. When it’s finished, try <span data-line="8;logs_backups.md::390"></span><code class="code">echo $?</code><span data-line="8;logs_backups.md::390"></span>. If the result is anything
other than 0, it means that amdump ended in an error state and did
not run correctly. If it is 0, you’re golden.
</p></li>
<li data-line="8;logs_backups.md:394">
<p data-line="8;logs_backups.md:394"><span data-line="8;logs_backups.md::394"></span>Now run this command:
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:396"><code>amreport MyConfig &gt; /amanda/amandareport</code></pre>
<p data-line="8;logs_backups.md:398"><span data-line="8;logs_backups.md::398"></span>This command puts the report from running the backup into a file in
the amanda directory. Go view the file you just created. This is the
output that gets emailed to CS staff whenever amanda runs a backup
on Diffie.
</p></li></ol>

<p data-line="8;logs_backups.md:403"><span data-line="8;logs_backups.md::403"></span>Congratulations, you’ve finished your first backup! Now let’s figure out
how to restore the files that have been backed up.
</p><h3 id="restoring-a-backup"  data-line="8;logs_backups.md:406" ><span data-line="8;logs_backups.md::406"></span>Restoring a backup</h3>
<ol class="loose" data-line="8;logs_backups.md:409">
<li data-line="8;logs_backups.md:409">
<p data-line="8;logs_backups.md:409"><span data-line="8;logs_backups.md::409"></span>There are a few changes you need to make to the amanda client
configuration file,
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:411"><code>`/etc/amanda/amanda-client.conf`. Change the lines in this file to</code></pre>
<p data-line="8;logs_backups.md:412"><span data-line="8;logs_backups.md::412"></span>match the ones below:
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:414"><code>conf &quot;MyConfig&quot;
index_server &quot;localhost&quot;
tape_server &quot;localhost&quot;
tapedev &quot;changer&quot;
auth &quot;local&quot;</code></pre>
<p data-line="8;logs_backups.md:420"><span data-line="8;logs_backups.md::420"></span>Don’t worry about the <span data-line="8;logs_backups.md::420"></span><code class="code">ssh_keys</code><span data-line="8;logs_backups.md::420"></span> line, just leave it as the empty
string.
</p></li>
<li data-line="8;logs_backups.md:423">
<p data-line="8;logs_backups.md:423"><span data-line="8;logs_backups.md::423"></span>Now we need to create a place where the backup will restore to. Go
to <span data-line="8;logs_backups.md::424"></span><code class="code">/tmp</code><span data-line="8;logs_backups.md::424"></span> and create the directory <span data-line="8;logs_backups.md::424"></span><code class="code">test-recovery</code><span data-line="8;logs_backups.md::424"></span>. Go to that
directory.
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:427"><code>mkdir /tmp/test-recovery
cd /tmp/test-recovery</code></pre></li>
<li data-line="8;logs_backups.md:430">
<p data-line="8;logs_backups.md:430"><span data-line="8;logs_backups.md::430"></span>Now you’re ready to restore the files. Since you need permission to
access files on the system, <span data-line="8;logs_backups.md::431"></span><code class="code">amrecover</code><span data-line="8;logs_backups.md::431"></span> needs to be run with sudo.
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:433"><code>amrecover MyConfig</code></pre>
<p data-line="8;logs_backups.md:435"><span data-line="8;logs_backups.md::435"></span>You should see something similar to the following. Now amrecover
will prompt you to enter information.
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:438"><code>Using index server from environment AMANDA_SERVER (penguin)
AMRECOVER Version 3.3.3. Contacting server on penguin ...
220 penguin AMANDA index server (3.3.3) ready.
Setting restore date to today (2014-07-08)
200 Working date set to 2014-07-08.
200 Config set to MyConfig.
501 Host penguin is not in your disklist.
Trying host localhost ...
200 Dump host set to localhost.
Use the setdisk command to choose dump disk to recover
amrecover&gt;</code></pre>
<p data-line="8;logs_backups.md:450"><span data-line="8;logs_backups.md::450"></span>Lines with errors begin with a 5 while the lines that work correctly
begin with a 2. If the program complains that the host is not in
your disklist, set the host to localhost by typing the following.
Otherwise, keep going.
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:455"><code>amrecover&gt; sethost localhost</code></pre></li>
<li data-line="8;logs_backups.md:457">
<p data-line="8;logs_backups.md:457"><span data-line="8;logs_backups.md::457"></span>Now set the disk to /home, the directory you backed up.
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:459"><code>amrecover&gt; setdisk /home</code></pre>
<p data-line="8;logs_backups.md:461"><span data-line="8;logs_backups.md::461"></span>Amrecover should confirm that it did the proposed action by printing
the following:
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:464"><code>200 Disk set to /home.</code></pre></li>
<li data-line="8;logs_backups.md:466">
<p data-line="8;logs_backups.md:466"><span data-line="8;logs_backups.md::466"></span>And add the name of your home directory (should be your user name):
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:468"><code>amrecover&gt; add &lt;directory name&gt;</code></pre>
<p data-line="8;logs_backups.md:470"><span data-line="8;logs_backups.md::470"></span>Again, amrecover should confirm that it added the directory:
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:472"><code>Added directory &lt;directory name&gt;</code></pre></li>
<li data-line="8;logs_backups.md:474">
<p data-line="8;logs_backups.md:474"><span data-line="8;logs_backups.md::474"></span>Now you’re ready to extract files.
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:476"><code>amrecover&gt; extract</code></pre>
<p data-line="8;logs_backups.md:478"><span data-line="8;logs_backups.md::478"></span>Amrecover will ask you to confirm what you want to do, and if it
looks right, type Y (make sure it is a capital Y or it will get
angry with you).
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:482"><code>Extracting files using tape drive changer on host localhost.
The following tapes are needed: MyData01

Extracting files using tape drive changer on host localhost.
Load tape MyData01 now
Continue [?/Y/n/s/d]? Y</code></pre>
<p data-line="8;logs_backups.md:489"><span data-line="8;logs_backups.md::489"></span>Amrecover should list the recovered files, returning you to the
amrecover prompt. If so, you have successfully restored your home
directory! That is the end of the recovery process, so type CTRL-D
to exit amrecover and return to your command prompt.
</p>
<p data-line="8;logs_backups.md:494"><span data-line="8;logs_backups.md::494"></span>If you run <span data-line="8;logs_backups.md::494"></span><code class="code">ls</code><span data-line="8;logs_backups.md::494"></span> in your current directory, <span data-line="8;logs_backups.md::494"></span><code class="code">/tmp/test-recovery</code><span data-line="8;logs_backups.md::494"></span>, you
should see a copy of your home directory.
</p></li></ol>
<h3 id="backups--activity"  data-line="8;logs_backups.md:497" ><span data-line="8;logs_backups.md::497"></span>Backups: Activity</h3>
<p data-line="8;logs_backups.md:500"><span data-line="8;logs_backups.md::500"></span>Now that you’ve successfully backed up your home directory, let’s back
up more files using the same process. Add a new configuration called
MyLogs to back up the disk <span data-line="8;logs_backups.md::502"></span><code class="code">/var/log</code><span data-line="8;logs_backups.md::502"></span>. To start out, as the amanda user
copy the MyConfig directory and name the new directory MyLogs. You will
need to change the name of the configuration in
<span data-line="8;logs_backups.md::505"></span><code class="code">/etc/amanda/MyLogs/amanda.conf</code><span data-line="8;logs_backups.md::505"></span> and <span data-line="8;logs_backups.md::505"></span><code class="code">/etc/amanda/amanda-client.conf</code><span data-line="8;logs_backups.md::505"></span>,
and change the disk to back up in <span data-line="8;logs_backups.md::506"></span><code class="code">/etc/amanda/MyLogs/disklist</code><span data-line="8;logs_backups.md::506"></span>. Then
run <span data-line="8;logs_backups.md::507"></span><code class="code">amcheck MyLogs</code><span data-line="8;logs_backups.md::507"></span> to check the new configuration and <span data-line="8;logs_backups.md::507"></span><code class="code">amdump MyLogs</code><span data-line="8;logs_backups.md::507"></span>
to actually perform the backup.
</p><h3 id="resources"  data-line="8;logs_backups.md:510" ><span data-line="8;logs_backups.md::510"></span>Resources</h3>
<p data-line="8;logs_backups.md:512"><span data-line="8;logs_backups.md::512"></span><a href="http://wiki.zmanda.com/index.php/GSWA/Build_a_Basic_Configuration">http://wiki.zmanda.com/index.php/GSWA/Build_a_Basic_Configuration</a><span data-line="8;logs_backups.md::512"></span>
</p>
<p class="indent" data-line="8;logs_backups.md:514"><span data-line="8;logs_backups.md::514"></span><a href="http://wiki.zmanda.com/index.php/GSWA/Recovering_Files">http://wiki.zmanda.com/index.php/GSWA/Recovering_Files</a><span data-line="8;logs_backups.md::514"></span>
</p><h2 id="important"  data-line="8;logs_backups.md:516" ><span data-line="8;logs_backups.md::516"></span>Important!</h2>
<p data-line="8;logs_backups.md:518"><span data-line="8;logs_backups.md::518"></span>Before continuing, run the following command:
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:520"><code>sudo ./MysteriousScript2</code></pre><h2 id="cron-jobs"  data-line="8;logs_backups.md:522" ><span data-line="8;logs_backups.md::522"></span>Cron Jobs</h2>
<p data-line="8;logs_backups.md:525"><span data-line="8;logs_backups.md::525"></span>Backups are so important that you should do them often, at regular
intervals. It can be difficult to remember to do backups, so that is one
of the reasons that cron jobs exist. Cron jobs automate processes so
they will run at set intervals, which is perfect for keeping a system’s
backups up-to-date.
</p>
<p class="indent" data-line="8;logs_backups.md:531"><span data-line="8;logs_backups.md::531"></span>The cron jobs running on your system are listed in the <span data-line="8;logs_backups.md::531"></span><code class="code">/etc/crontab</code><span data-line="8;logs_backups.md::531"></span>.
Go take a look at the file. Here is a sample line from this file:
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:534"><code>19 4 * * 0,3,6  root    rm -f /var/spool/cron/lastrun/cron.weekly</code></pre>
<p data-line="8;logs_backups.md:536"><span data-line="8;logs_backups.md::536"></span>The last part of the line is fairly straightforward. <span data-line="8;logs_backups.md::536"></span><code class="code">root</code><span data-line="8;logs_backups.md::536"></span> is the user
running the command, and following root is the command itself. The
beginning of the line may look ambiguous, but it describes how often the
job should run. The numbers represent:
</p>
<pre class="para-block para-block" data-line="8;logs_backups.md:541"><code>19        4        *                *        0,3,6
minutes   hours    day (of month)   month    day (of week)
(0-59)    (0-23)   (1-31)           (1-12)   (0-6)         # allowable values</code></pre>
<p data-line="8;logs_backups.md:545"><span data-line="8;logs_backups.md::545"></span>So, this particular command removes the file <span data-line="8;logs_backups.md::545"></span><code class="code">cron.weekly</code><span data-line="8;logs_backups.md::545"></span> at 4:19am
every Sunday, Wednesday, and Saturday.
</p><h3 id="cron-jobs--activity"  data-line="8;logs_backups.md:548" ><span data-line="8;logs_backups.md::548"></span>Cron Jobs: Activity</h3>
<p data-line="8;logs_backups.md:550"><span data-line="8;logs_backups.md::550"></span>Add two lines to the crontab file to check the configuration of MyConfig
at 9pm and run a backup every day at 9:30pm. Set up amcheck so that
instead of printing to standard output like it usually does, it mails
the output to root. (Reminder: the amanda commands have man pages just
like any other command!)
</p><h2 id="sysadmin--activity"  data-line="8;logs_backups.md:556" ><span data-line="8;logs_backups.md::556"></span>SysAdmin: Activity</h2>
<p data-line="8;logs_backups.md:557"><span data-line="8;logs_backups.md::557"></span>Check the root<span data-line="8;logs_backups.md::557"></span>&#39;<span data-line="8;logs_backups.md::557"></span>s mail.
</p>
</body>
</html>
